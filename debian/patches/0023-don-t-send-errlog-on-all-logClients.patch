From: Dirk Zimoch <dirk.zimoch@psi.ch>
Date: Tue, 27 Aug 2019 16:51:00 +0200
Subject: don't send errlog on all logClients

---
 src/libCom/log/iocLog.c    | 14 ++++++++++++++
 src/libCom/log/logClient.c |  4 ----
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/src/libCom/log/iocLog.c b/src/libCom/log/iocLog.c
index e62da20..8cb1349 100644
--- a/src/libCom/log/iocLog.c
+++ b/src/libCom/log/iocLog.c
@@ -18,8 +18,10 @@
 
 #define epicsExportSharedSymbols
 #include "envDefs.h"
+#include "errlog.h"
 #include "logClient.h"
 #include "iocLog.h"
+#include "epicsExit.h"
 
 int iocLogDisable = 0;
 
@@ -74,6 +76,14 @@ void epicsShareAPI epicsShareAPI iocLogFlush (void)
     }
 }
 
+/*
+ * logClientDestroy()
+ */
+static void iocLogClientDestroy (logClientId id)
+{
+    errlogRemoveListeners (logClientSendMessage, id);
+}
+
 /*
  *  iocLogClientInit()
  */
@@ -89,6 +99,10 @@ static logClientId iocLogClientInit (void)
         return NULL;
     }
     id = logClientCreate (addr, port);
+    if (id != NULL) {
+        errlogAddListener (logClientSendMessage, id);
+        epicsAtExit (iocLogClientDestroy, id);
+    }
     return id;
 }
 
diff --git a/src/libCom/log/logClient.c b/src/libCom/log/logClient.c
index 99ee671..b076d50 100644
--- a/src/libCom/log/logClient.c
+++ b/src/libCom/log/logClient.c
@@ -154,8 +154,6 @@ static void logClientDestroy (logClientId id)
         return;
     }
 
-    errlogRemoveListeners ( logClientSendMessage, (void *) pClient );
-
     logClientClose ( pClient );
 
     epicsMutexDestroy ( pClient->mutex );
@@ -549,8 +547,6 @@ logClientId epicsShareAPI logClientCreate (
             pClient->name, LOG_SERVER_CREATE_CONNECT_SYNC_TIMEOUT );
     }
         
-    errlogAddListener ( logClientSendMessage, (void *) pClient );
-
     return (void *) pClient;
 }
 
