From: Dirk Zimoch <dirk.zimoch@psi.ch>
Date: Fri, 4 Oct 2019 14:32:07 +0200
Subject: use EPICS_PRIVATE_API macro and fix bug with darwin/ios

---
 src/libCom/log/logClient.c                     | 1 +
 src/libCom/osi/os/Darwin/osdSockUnsentCount.c  | 4 +++-
 src/libCom/osi/os/Linux/osdSockUnsentCount.c   | 1 +
 src/libCom/osi/os/WIN32/osdSockUnsentCount.c   | 1 +
 src/libCom/osi/os/default/osdSockUnsentCount.c | 1 +
 src/libCom/osi/os/iOS/osdSockUnsentCount.c     | 4 +++-
 src/libCom/osi/osiSock.h                       | 2 ++
 7 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/src/libCom/log/logClient.c b/src/libCom/log/logClient.c
index 73664ff..9a09ef7 100644
--- a/src/libCom/log/logClient.c
+++ b/src/libCom/log/logClient.c
@@ -21,6 +21,7 @@
 #include <string.h>
 #include <stdio.h>
 
+#define EPICS_PRIVATE_API
 #define epicsExportSharedSymbols
 #include "dbDefs.h"
 #include "epicsEvent.h"
diff --git a/src/libCom/osi/os/Darwin/osdSockUnsentCount.c b/src/libCom/osi/os/Darwin/osdSockUnsentCount.c
index 00ef550..20bd82b 100644
--- a/src/libCom/osi/os/Darwin/osdSockUnsentCount.c
+++ b/src/libCom/osi/os/Darwin/osdSockUnsentCount.c
@@ -3,6 +3,7 @@
 * in file LICENSE that is included with this distribution.
 \*************************************************************************/
 
+#define EPICS_PRIVATE_API
 #include "osiSock.h"
 
 /*
@@ -11,7 +12,8 @@
  */
 int epicsSocketUnsentCount(SOCKET sock) {
     int unsent;
-    if (getsockopt(sock, SOL_SOCKET, SO_NWRITE, &unsent) == 0)
+    socklen_t len = sizeof(unsent);
+    if (getsockopt(sock, SOL_SOCKET, SO_NWRITE, &unsent, &len) == 0)
         return unsent;
     return -1;
 }
diff --git a/src/libCom/osi/os/Linux/osdSockUnsentCount.c b/src/libCom/osi/os/Linux/osdSockUnsentCount.c
index 6f6cbf0..3c0a8f9 100644
--- a/src/libCom/osi/os/Linux/osdSockUnsentCount.c
+++ b/src/libCom/osi/os/Linux/osdSockUnsentCount.c
@@ -4,6 +4,7 @@
 \*************************************************************************/
 
 #include <linux/sockios.h>
+#define EPICS_PRIVATE_API
 #include "osiSock.h"
 
 /*
diff --git a/src/libCom/osi/os/WIN32/osdSockUnsentCount.c b/src/libCom/osi/os/WIN32/osdSockUnsentCount.c
index c2045bc..fe68ead 100644
--- a/src/libCom/osi/os/WIN32/osdSockUnsentCount.c
+++ b/src/libCom/osi/os/WIN32/osdSockUnsentCount.c
@@ -4,6 +4,7 @@
 \*************************************************************************/
 
 #define epicsExportSharedSymbols
+#define EPICS_PRIVATE_API
 #include "osiSock.h"
 #include <mstcpip.h>
 
diff --git a/src/libCom/osi/os/default/osdSockUnsentCount.c b/src/libCom/osi/os/default/osdSockUnsentCount.c
index 61094c7..ef01e9b 100644
--- a/src/libCom/osi/os/default/osdSockUnsentCount.c
+++ b/src/libCom/osi/os/default/osdSockUnsentCount.c
@@ -3,6 +3,7 @@
 * in file LICENSE that is included with this distribution.
 \*************************************************************************/
 
+#define EPICS_PRIVATE_API
 #include "osiSock.h"
 
 /*
diff --git a/src/libCom/osi/os/iOS/osdSockUnsentCount.c b/src/libCom/osi/os/iOS/osdSockUnsentCount.c
index 00ef550..20bd82b 100644
--- a/src/libCom/osi/os/iOS/osdSockUnsentCount.c
+++ b/src/libCom/osi/os/iOS/osdSockUnsentCount.c
@@ -3,6 +3,7 @@
 * in file LICENSE that is included with this distribution.
 \*************************************************************************/
 
+#define EPICS_PRIVATE_API
 #include "osiSock.h"
 
 /*
@@ -11,7 +12,8 @@
  */
 int epicsSocketUnsentCount(SOCKET sock) {
     int unsent;
-    if (getsockopt(sock, SOL_SOCKET, SO_NWRITE, &unsent) == 0)
+    socklen_t len = sizeof(unsent);
+    if (getsockopt(sock, SOL_SOCKET, SO_NWRITE, &unsent, &len) == 0)
         return unsent;
     return -1;
 }
diff --git a/src/libCom/osi/osiSock.h b/src/libCom/osi/osiSock.h
index e1c2de8..6e3b053 100644
--- a/src/libCom/osi/osiSock.h
+++ b/src/libCom/osi/osiSock.h
@@ -52,12 +52,14 @@ enum epicsSocketSystemCallInterruptMechanismQueryInfo {
 epicsShareFunc enum epicsSocketSystemCallInterruptMechanismQueryInfo 
         epicsSocketSystemCallInterruptMechanismQuery ();
 
+#ifdef EPICS_PRIVATE_API
 /*
  * Some systems (e.g Linux and Windows 10) allow to check the amount
  * of unsent data in the output queue.
  * Returns -1 if the information is not available.
  */
 epicsShareFunc int epicsSocketUnsentCount(SOCKET sock);
+#endif
 
 /*
  * convert socket address to ASCII in this order
